<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="An AI-powered screen reader purpose-built for Animal Crossing. Point your camera at in-game text and hear it read aloud!">
  <meta name="theme-color" content="#7ec97f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Read It!">
  <title>Read It! - Animal Crossing Screen Reader</title>
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
  <link rel="icon" href="/assets/favicon.ico" sizes="any">
  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
  <link rel="manifest" href="/assets/manifest.json">
  <meta property="og:title" content="Read It! - Animal Crossing Screen Reader">
  <meta property="og:description" content="An AI-powered screen reader purpose-built for Animal Crossing. Point your camera at in-game text and hear it read aloud!">
  <meta property="og:image" content="/assets/icon-512.png">
  <meta property="og:type" content="website">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@700;800;900&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }

    :root {
      --cream:        #f5efd5;
      --green:        #7ec97f;
      --green-dark:   #3d7a44;
      --green-found:  #4caf50;
      --brown:        #7a4f2c;
      --brown-light:  #c49060;
      --sky:          #a8d9ec;
      --sky-dark:     #5fa8c8;
      --yellow:       #f5d45a;
      --yellow-dark:  #c9a920;
      --orange:       #f0921e;
      --orange-dark:  #b86a00;
      --white:        #fffef5;
      --text:         #4a3220;
      --gray:         #b0a090;
      --gray-dark:    #8a7a6a;
    }

    html, body {
      height: 100%;
      height: 100dvh;
      overflow: hidden;
    }

    body {
      background: url('grass-wallpaper.webp') center / cover no-repeat fixed;
      background-color: var(--cream);
      font-family: 'Nunito', sans-serif;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      user-select: none;
    }

    /* â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .header {
      background:
        linear-gradient(180deg,
          rgba(255,255,255,0.18) 0%,
          rgba(200,160,100,0.05) 30%,
          rgba(0,0,0,0.12) 100%),
        linear-gradient(90deg,
          #a07040 0%, #c49060 12%, #daa870 25%, #c49060 38%,
          #a07040 50%, #c49060 62%, #daa870 75%, #c49060 88%, #a07040 100%);
      padding: 10px 16px 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 5px solid #5a3518;
      border-top: 3px solid #dab880;
      box-shadow:
        0 4px 8px rgba(0,0,0,0.35),
        inset 0 1px 0 rgba(255,255,255,0.25),
        inset 0 -2px 4px rgba(0,0,0,0.15);
      flex-shrink: 0;
      position: relative;
      z-index: 10;
    }

    .header-title {
      font-family: 'Fredoka One', cursive;
      font-size: clamp(1.5rem, 5vw, 2rem);
      color: #f8d830;
      text-shadow:
        -2px -2px 0 #7a4f2c,
         2px -2px 0 #7a4f2c,
        -2px  2px 0 #7a4f2c,
         2px  2px 0 #7a4f2c,
         0   3px 0  #5a3518,
         0   4px 6px rgba(0,0,0,0.3);
      letter-spacing: 2px;
    }

    /* â”€â”€â”€ CAMERA WRAPPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .camera-wrap {
      flex: 1;
      padding: 12px 12px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      min-height: 0;
      overflow: hidden;
    }

    .camera-frame {
      width: 100%;
      max-height: 100%;
      aspect-ratio: 16 / 10;
      position: relative;
      border-radius: 28px;
      border: 5px solid var(--brown);
      box-shadow: 0 6px 0 var(--brown), 0 10px 30px rgba(0,0,0,0.25);
      overflow: hidden;
      background: var(--sky);
      transition: border-color 0.4s, box-shadow 0.4s;
    }

    .camera-frame.state-found {
      border-color: var(--green-found);
      box-shadow:
        0 0 0 4px rgba(76,175,80,0.6),
        0 0 35px rgba(76,175,80,0.4),
        0 6px 0 #388e3c;
      animation: pulse-found 1.8s ease-in-out infinite;
    }

    @keyframes pulse-found {
      0%, 100% { box-shadow: 0 0 0 3px rgba(76,175,80,0.5), 0 0 25px rgba(76,175,80,0.3), 0 6px 0 #388e3c; }
      50%       { box-shadow: 0 0 0 7px rgba(76,175,80,0.7), 0 0 50px rgba(76,175,80,0.6), 0 6px 0 #388e3c; }
    }

    /* â”€â”€â”€ VIDEO / CANVAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }

    #canvas {
      display: none;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #canvas.frozen {
      display: block;
    }

    /* â”€â”€â”€ SPLASH SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .splash {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      background: linear-gradient(160deg, #b8e6ef 0%, #d4f0d8 60%, #f0e8c0 100%);
      padding: 20px;
    }

    .splash-animals {
      font-size: 3.5rem;
      letter-spacing: 8px;
      animation: float-row 3s ease-in-out infinite;
    }

    @keyframes float-row {
      0%, 100% { transform: translateY(0); }
      50%       { transform: translateY(-8px); }
    }

    .splash-label {
      font-family: 'Fredoka One', cursive;
      font-size: 1.3rem;
      color: var(--text);
      text-align: center;
    }

    .start-btn {
      background: var(--green);
      border: 4px solid var(--green-dark);
      border-radius: 50px;
      box-shadow: 0 6px 0 var(--green-dark);
      padding: 14px 36px;
      font-family: 'Fredoka One', cursive;
      font-size: 1.4rem;
      color: var(--white);
      cursor: pointer;
      -webkit-appearance: none;
      transition: transform 0.1s, box-shadow 0.1s;
    }

    .start-btn:active {
      transform: translateY(4px);
      box-shadow: 0 2px 0 var(--green-dark);
    }

    /* â”€â”€â”€ SCANNING OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .scan-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 14px;
      background: rgba(116,201,122,0.25);
      backdrop-filter: blur(2px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s;
    }

    .scan-overlay.visible {
      opacity: 1;
    }

    .scan-spinner {
      width: 56px;
      height: 56px;
      animation: spin 0.9s linear infinite;
      filter: drop-shadow(0 0 12px rgba(100,200,100,0.8));
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }

    .scan-label {
      background: var(--white);
      border: 3px solid var(--green-dark);
      border-radius: 50px;
      padding: 6px 20px;
      font-family: 'Fredoka One', cursive;
      font-size: 1.2rem;
      color: var(--green-dark);
      box-shadow: 0 3px 0 var(--green-dark);
    }

    /* â”€â”€â”€ AC DIALOG BOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ac-dialog {
      width: 100%;
      flex-shrink: 0;
      position: relative;
      display: none;
      animation: pop-in 0.35s cubic-bezier(0.34,1.56,0.64,1);
      background: url('dialogue-box.webp') center / 100% 100% no-repeat;
      padding: 18px 26px 20px 30px;
      height: 200px;
      overflow: hidden;
    }

    .ac-dialog.visible { display: block; }

    .ac-dialog-text {
      font-size: 1rem;
      font-weight: 800;
      color: var(--text);
      line-height: 1.5;
      text-align: center;
      height: 100%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      touch-action: pan-y;
    }

    .ac-dialog-text .word {
      transition: background-color 0.12s, color 0.12s;
      border-radius: 4px;
      padding: 1px 2px;
    }

    .ac-dialog-text .word.highlight {
      background-color: var(--yellow);
      color: var(--brown);
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }

    /* Arrow is built into the dialogue box image */

    @keyframes pop-in {
      from { transform: scale(0.85); opacity: 0; }
      to   { transform: scale(1);    opacity: 1; }
    }

    /* â”€â”€â”€ STATUS DOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .status-dot {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--gray);
      border: 3px solid var(--gray-dark);
      z-index: 5;
      transition: background 0.3s, border-color 0.3s;
    }

    .status-dot.ready    { background: var(--green-found); border-color: #388e3c; }
    .status-dot.scanning { background: var(--yellow); border-color: var(--yellow-dark); animation: blink 0.5s ease-in-out infinite alternate; }
    .status-dot.speaking { background: var(--orange); border-color: var(--orange-dark); }

    @keyframes blink {
      from { opacity: 1; }
      to   { opacity: 0.3; }
    }

    /* â”€â”€â”€ CONTROLS DOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .controls {
      background: linear-gradient(180deg, rgba(245,239,213,0.92) 0%, rgba(232,223,192,0.95) 100%);
      border-top: 4px solid var(--brown-light);
      padding: 10px 14px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      flex-shrink: 0;
    }

    /* All buttons share base */
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      border-radius: 50%;
      -webkit-appearance: none;
      font-size: inherit;
      transition: transform 0.08s, box-shadow 0.08s;
      position: relative;
    }

    .btn:active:not(:disabled) {
      transform: translateY(4px) scale(0.94);
    }

    /* â”€â”€â”€ SCAN BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-scan {
      width: 82px;
      height: 82px;
      background: var(--yellow);
      border: 5px solid var(--brown);
      box-shadow: 0 7px 0 var(--brown), 0 10px 20px rgba(0,0,0,0.15);
      font-size: 2.4rem;
    }

    .btn-scan:active:not(:disabled) {
      box-shadow: 0 2px 0 var(--brown);
    }

    .btn-scan:disabled {
      background: #ddd;
      border-color: #aaa;
      box-shadow: 0 4px 0 #aaa;
      cursor: not-allowed;
    }

    .btn-scan.scanning {
      background: #f08080;
      border-color: #a04040;
      box-shadow: 0 7px 0 #a04040, 0 10px 20px rgba(0,0,0,0.15);
    }

    .btn-scan.scanning:active {
      box-shadow: 0 2px 0 #a04040;
    }

    /* â”€â”€â”€ SPEAK BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-speak {
      width: 70px;
      height: 70px;
      background: var(--gray);
      border: 4px solid var(--gray-dark);
      box-shadow: 0 5px 0 var(--gray-dark);
      font-size: 2rem;
      opacity: 0.45;
      pointer-events: none;
      transition: background 0.3s, border-color 0.3s, box-shadow 0.3s, opacity 0.3s, transform 0.08s;
    }

    .btn-speak.active {
      background: var(--green);
      border-color: var(--green-dark);
      box-shadow: 0 5px 0 var(--green-dark);
      opacity: 1;
      pointer-events: auto;
      animation: wiggle 2s ease-in-out infinite;
    }

    .btn-speak.speaking {
      background: var(--orange);
      border-color: var(--orange-dark);
      box-shadow: 0 5px 0 var(--orange-dark);
      opacity: 1;
      pointer-events: auto;
      animation: none;
    }

    .btn-speak:active:not(:disabled) {
      box-shadow: 0 2px 0 currentColor;
    }

    @keyframes wiggle {
      0%, 100%  { transform: rotate(0deg); }
      10%, 30%  { transform: rotate(-10deg); }
      20%, 40%  { transform: rotate(10deg); }
      50%       { transform: rotate(0deg); }
    }

    /* â”€â”€â”€ RETRY BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-retry {
      width: 60px;
      height: 60px;
      background: var(--sky);
      border: 4px solid var(--sky-dark);
      box-shadow: 0 5px 0 var(--sky-dark);
      font-size: 1.7rem;
      opacity: 0.4;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .btn-retry.active {
      opacity: 1;
      pointer-events: auto;
    }

    .btn-retry:active.active {
      box-shadow: 0 2px 0 var(--sky-dark);
    }

    /* â”€â”€â”€ CONTEXT BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-context {
      width: 60px;
      height: 60px;
      background: var(--gray);
      border: 4px solid var(--gray-dark);
      box-shadow: 0 5px 0 var(--gray-dark);
      font-size: 1.7rem;
      opacity: 0.4;
      pointer-events: none;
      transition: background 0.3s, border-color 0.3s, box-shadow 0.3s, opacity 0.3s, transform 0.08s;
    }

    .btn-context.active {
      background: #e8b4d0;
      border-color: #b07898;
      box-shadow: 0 5px 0 #b07898;
      opacity: 1;
      pointer-events: auto;
    }

    .btn-context.loading {
      background: #e8b4d0;
      border-color: #b07898;
      box-shadow: 0 5px 0 #b07898;
      opacity: 1;
      pointer-events: auto;
      animation: blink 0.5s ease-in-out infinite alternate;
    }

    .btn-context:active.active {
      box-shadow: 0 2px 0 #b07898;
    }

    /* â”€â”€â”€ GUIDE BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-guide {
      width: 60px;
      height: 60px;
      background: var(--gray);
      border: 4px solid var(--gray-dark);
      box-shadow: 0 5px 0 var(--gray-dark);
      font-size: 1.7rem;
      opacity: 0.4;
      pointer-events: none;
      transition: background 0.3s, border-color 0.3s, box-shadow 0.3s, opacity 0.3s, transform 0.08s;
    }

    .btn-guide.active {
      background: #f0a870;
      border-color: #b87840;
      box-shadow: 0 5px 0 #b87840;
      opacity: 1;
      pointer-events: auto;
    }

    .btn-guide.loading {
      background: #f0a870;
      border-color: #b87840;
      box-shadow: 0 5px 0 #b87840;
      opacity: 1;
      pointer-events: auto;
      animation: blink 0.5s ease-in-out infinite alternate;
    }

    .btn-guide:active.active {
      box-shadow: 0 2px 0 #b87840;
    }

    /* SVG icon styling */
    .btn svg {
      display: block;
    }

    .btn-speak svg {
      color: var(--white);
    }

    /* â”€â”€â”€ SPEAKING PULSE RING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .waves {
      position: absolute;
      inset: -4px;
      border-radius: 50%;
      border: 3px solid var(--orange);
      opacity: 0;
      pointer-events: none;
    }

    .btn-speak.speaking .waves {
      animation: wave-out 1s ease-out infinite;
    }

    @keyframes wave-out {
      0%   { transform: scale(1);   opacity: 0.8; }
      100% { transform: scale(1.7); opacity: 0; }
    }

    /* â”€â”€â”€ CONFETTI BURST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .confetti-dot {
      position: absolute;
      border-radius: 50%;
      pointer-events: none;
      animation: confetti-fly 0.8s ease-out forwards;
    }

    @keyframes confetti-fly {
      0%   { transform: translate(0,0) scale(1); opacity: 1; }
      100% { transform: var(--end-pos) scale(0); opacity: 0; }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="header">
    <span class="header-title">AC. Read It!</span>
  </div>

  <!-- CAMERA AREA -->
  <div class="camera-wrap">
    <div class="camera-frame" id="cameraFrame">

      <!-- Splash / Start screen -->
      <div class="splash" id="splash">
        <div class="splash-animals">ğŸ¦ğŸ¸ğŸ°</div>
        <div class="splash-label">Point your camera<br>at the words!</div>
        <button class="start-btn" id="startBtn" onclick="startCamera()">ğŸ“· Start!</button>
      </div>

      <!-- Live video -->
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas"></canvas>

      <!-- Status indicator -->
      <div class="status-dot" id="statusDot"></div>

      <!-- Scanning overlay -->
      <div class="scan-overlay" id="scanOverlay">
        <img class="scan-spinner" src="leaf.webp" alt="Loading">
        <div class="scan-label">Reading...</div>
      </div>

    </div>

    <!-- AC Dialog Box (below camera) -->
    <div class="ac-dialog" id="resultBubble">
      <div class="ac-dialog-text" id="resultText"></div>
    </div>
  </div>

  <!-- CONTROLS DOCK -->
  <div class="controls">
    <button class="btn btn-retry" id="retryBtn" onclick="retry()">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#3d6e8c" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
    </button>
    <button class="btn btn-scan"  id="scanBtn"  onclick="captureAndScan()">
      <svg width="34" height="34" viewBox="0 0 24 24" fill="none" stroke="var(--brown)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
    </button>
    <button class="btn btn-speak" id="speakBtn" onclick="speakText()">
      <div class="waves"></div>
      <svg class="megaphone-icon" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.5 3 L18.5 21 L7 15 L7 9 Z"/><path d="M7 9 L3.5 9 C2.7 9 2 9.7 2 10.5 L2 13.5 C2 14.3 2.7 15 3.5 15 L7 15"/><path d="M18.5 6 C20.5 8 20.5 16 18.5 18"/><path d="M7 15 L8 20 L11 20 L10 15"/></svg>
    </button>
    <button class="btn btn-guide" id="guideBtn" onclick="explainGuide()">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#5a3518" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8l4 4-4 4"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
    </button>
    <button class="btn btn-context" id="contextBtn" onclick="explainContext()">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#5a3518" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
    </button>
  </div>

  <script>
    // â”€â”€ Sound Effects (Web Audio API) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let audioCtx = null;

    function getAudioCtx() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') audioCtx.resume();
      return audioCtx;
    }

    function playTone(freq, duration, type, vol, detune) {
      const ctx = getAudioCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = type || 'sine';
      osc.frequency.value = freq;
      if (detune) osc.detune.value = detune;
      gain.gain.setValueAtTime(vol || 0.25, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + duration);
    }

    // Camera shutter â€” quick two-note chirp (like AC menu select)
    function sfxShutter() {
      playTone(880, 0.08, 'sine', 0.2);
      setTimeout(() => playTone(1175, 0.12, 'sine', 0.25), 60);
    }

    // Cancel â€” soft descending tone
    function sfxCancel() {
      playTone(660, 0.1, 'triangle', 0.18);
      setTimeout(() => playTone(440, 0.15, 'triangle', 0.15), 80);
    }

    // Retry â€” gentle rising boop
    function sfxRetry() {
      playTone(523, 0.08, 'sine', 0.18);
      setTimeout(() => playTone(659, 0.1, 'sine', 0.2), 70);
    }

    // Speak â€” cheerful three-note chime (like AC dialogue start)
    function sfxSpeak() {
      playTone(784, 0.1, 'sine', 0.2);
      setTimeout(() => playTone(988, 0.1, 'sine', 0.22), 80);
      setTimeout(() => playTone(1175, 0.15, 'sine', 0.18), 170);
    }

    // Found text â€” success jingle
    function sfxFound() {
      playTone(659, 0.1, 'sine', 0.2);
      setTimeout(() => playTone(784, 0.1, 'sine', 0.2), 100);
      setTimeout(() => playTone(988, 0.1, 'sine', 0.22), 200);
      setTimeout(() => playTone(1319, 0.2, 'sine', 0.25), 300);
    }

    // Context â€” curious rising two-note
    function sfxContext() {
      playTone(523, 0.12, 'sine', 0.18);
      setTimeout(() => playTone(784, 0.15, 'sine', 0.2), 100);
    }

    // Guide â€” bright ascending three-note (like getting a tip)
    function sfxGuide() {
      playTone(698, 0.1, 'sine', 0.2);
      setTimeout(() => playTone(880, 0.1, 'sine', 0.22), 90);
      setTimeout(() => playTone(1047, 0.15, 'sine', 0.2), 180);
    }

    // â”€â”€ Speech unlock (iOS requires user gesture to activate) â”€â”€
    let speechUnlocked = false;
    function unlockSpeech() {
      if (speechUnlocked) return;
      const u = new SpeechSynthesisUtterance(' ');
      u.volume = 0.01;
      u.rate = 10;
      window.speechSynthesis.speak(u);
      speechUnlocked = true;
    }

    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let stream           = null;
    let recognizedText   = '';
    let displayedText    = '';   // tracks what's currently shown in the dialog
    let isSpeaking       = false;
    let scanController   = null;  // AbortController for in-flight OCR
    let lastImageDataUrl = '';    // saved capture for context API
    let contextController = null; // AbortController for in-flight context
    let guideController    = null; // AbortController for in-flight guide

    // â”€â”€ Voice selection (priority order) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function pickVoice() {
      const voices = window.speechSynthesis.getVoices();
      if (!voices.length) return null;

      // Try each preferred voice in priority order
      const priorities = [
        v => v.name.includes('Samantha'),
        v => v.name.includes('Karen'),
        v => v.name.includes('Moira'),
        v => v.lang === 'en-US',
        v => v.lang && v.lang.startsWith('en')
      ];

      for (const test of priorities) {
        const match = voices.find(test);
        if (match) return match;
      }
      return null;
    }

    // â”€â”€ Start Camera â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function startCamera() {
      unlockSpeech();
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: 'environment' },
            width:  { ideal: 1920 },
            height: { ideal: 1080 }
          },
          audio: false
        });

        const video = document.getElementById('video');
        video.srcObject = stream;
        video.style.display = 'block';
        document.getElementById('splash').style.display = 'none';
        document.getElementById('statusDot').className = 'status-dot ready';

      } catch (e) {
        document.getElementById('splash').querySelector('.splash-label').textContent =
          'Tap Allow Camera to get started!';
        document.getElementById('startBtn').textContent = 'ğŸ“· Try Again!';
      }
    }

    // â”€â”€ Cancel in-flight scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function cancelScan() {
      sfxCancel();
      if (scanController) {
        scanController.abort();
        scanController = null;
      }
      setScanningUI(false);

      // Unfreeze: reopen viewfinder
      document.getElementById('canvas').classList.remove('frozen');
      document.getElementById('video').style.display = 'block';

      document.getElementById('statusDot').className = 'status-dot ready';
    }

    // â”€â”€ Capture & OCR (via Vercel AI Gateway) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function captureAndScan() {
      unlockSpeech();
      // If already scanning, cancel it
      if (scanController) {
        cancelScan();
        return;
      }

      const video = document.getElementById('video');

      if (!stream || !video.videoWidth) {
        startCamera();
        return;
      }

      // Reset UI
      cancelSpeech();
      recognizedText = '';
      displayedText = '';
      lastImageDataUrl = '';
      hasAutoRead = false;
      setFound(false);
      hideBubble();
      setSpeakState('idle');
      setContextState('idle');
      setGuideState('idle');
      setRetryActive(false);

      // Unfreeze previous capture if any
      document.getElementById('canvas').classList.remove('frozen');
      video.style.display = 'block';

      // Show scanning overlay (scan button becomes cancel button)
      sfxShutter();
      setScanningUI(true);

      // Capture only the visible (cropped) portion of the video
      const canvas = document.getElementById('canvas');
      const frame = document.getElementById('cameraFrame');
      const frameW = frame.clientWidth;
      const frameH = frame.clientHeight;
      const videoW = video.videoWidth;
      const videoH = video.videoHeight;

      // Calculate the object-fit: cover crop region
      const frameAspect = frameW / frameH;
      const videoAspect = videoW / videoH;
      let sx, sy, sw, sh;
      if (videoAspect > frameAspect) {
        // Video wider than frame â€” crop sides
        sh = videoH;
        sw = Math.round(videoH * frameAspect);
        sx = Math.round((videoW - sw) / 2);
        sy = 0;
      } else {
        // Video taller than frame â€” crop top/bottom
        sw = videoW;
        sh = Math.round(videoW / frameAspect);
        sx = 0;
        sy = Math.round((videoH - sh) / 2);
      }

      canvas.width = sw;
      canvas.height = sh;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, sx, sy, sw, sh, 0, 0, sw, sh);

      // Freeze: show canvas, hide video
      video.style.display = 'none';
      canvas.classList.add('frozen');

      // Export as JPEG for reasonable payload size
      const imageDataUrl = canvas.toDataURL('image/jpeg', 0.85);
      lastImageDataUrl = imageDataUrl;

      // Create abort controller for this scan
      scanController = new AbortController();

      try {
        const response = await fetch('/api/ocr', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: imageDataUrl }),
          signal: scanController.signal,
        });

        if (!response.ok) {
          const errData = await response.json().catch(() => ({}));
          throw new Error(JSON.stringify(errData.debug || { status: response.status }));
        }

        const data = await response.json();
        const text = (data.text || '').replace(/\s+/g, ' ').trim();
        // Debug: log raw response
        console.log('OCR response:', JSON.stringify(data));

        setScanningUI(false);

        // Unfreeze: reopen viewfinder for immediate next photo
        document.getElementById('canvas').classList.remove('frozen');
        video.style.display = 'block';

        if (text && text.length > 1) {
          recognizedText = text;
          displayedText = text;
          setFound(true);
          showBubbleWithWords(text);
          setSpeakState('active');
          setContextState('active');
          setGuideState('active');
          sfxFound();
          spawnConfetti();
          document.getElementById('statusDot').className = 'status-dot ready';

          // Auto-read: speak the text after a brief delay for the success jingle
          setTimeout(() => speakText(true), 500);
          setRetryActive(true);
        } else {
          showBubble('\uD83E\uDD14 No words found \u2014 try again!');
          document.getElementById('statusDot').className = 'status-dot';
        }

      } catch (e) {
        // If aborted by user, just return silently (cancelScan already cleaned up)
        if (e.name === 'AbortError') {
          scanController = null;
          return;
        }

        setScanningUI(false);
        console.error('Scan error:', e);
        showBubble('\uD83D\uDE05 Error: ' + (e.message || 'Try again!').substring(0, 120));
        document.getElementById('statusDot').className = 'status-dot';

        // Unfreeze on error too
        document.getElementById('canvas').classList.remove('frozen');
        video.style.display = 'block';
      }

      scanController = null;
    }

    // â”€â”€ Speak â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function speakText(auto) {
      if (!displayedText) return;

      // Tap while speaking â†’ cancel and return to found state
      if (isSpeaking) {
        sfxCancel();
        cancelSpeech();
        clearHighlights();
        setSpeakState('active');
        document.getElementById('statusDot').className = 'status-dot ready';
        return;
      }

      // iOS requires cancel before new utterance
      window.speechSynthesis.cancel();

      // Re-render current displayed text with word spans
      showBubbleWithWords(displayedText);

      // Play speak sound only on manual tap
      if (!auto) sfxSpeak();

      const startSpeaking = () => {
        const utterance = new SpeechSynthesisUtterance(displayedText);
        utterance.rate   = 0.82;
        utterance.pitch  = 1.05;
        utterance.volume = 1.0;

        const voice = pickVoice();
        if (voice) utterance.voice = voice;

        isSpeaking = true;
        setSpeakState('speaking');
        document.getElementById('statusDot').className = 'status-dot speaking';

        utterance.onboundary = (event) => {
          if (event.name === 'word') {
            highlightWordAt(event.charIndex);
          }
        };

        utterance.onend = () => {
          isSpeaking = false;
          hasAutoRead = true;
          clearHighlights();
          setSpeakState('active');  // will now show replay icon
          document.getElementById('statusDot').className = 'status-dot ready';
        };

        utterance.onerror = () => {
          isSpeaking = false;
          clearHighlights();
          setSpeakState('active');
          document.getElementById('statusDot').className = 'status-dot ready';
        };

        window.speechSynthesis.speak(utterance);
      };

      // Auto-triggered: speak immediately (speech already unlocked)
      // Manual tap: short delay to let sfx play first
      if (auto) {
        startSpeaking();
      } else {
        setTimeout(startSpeaking, 50);
      }
    }

    function cancelSpeech() {
      window.speechSynthesis.cancel();
      isSpeaking = false;
    }

    // â”€â”€ Retry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function retry() {
      sfxRetry();
      cancelSpeech();
      recognizedText = '';
      displayedText = '';
      lastImageDataUrl = '';
      hasAutoRead = false;
      setFound(false);
      hideBubble();
      setSpeakState('idle');
      setContextState('idle');
      setGuideState('idle');
      setRetryActive(false);
      document.getElementById('statusDot').className = 'status-dot ready';

      // Unfreeze: show video, hide canvas
      document.getElementById('canvas').classList.remove('frozen');
      document.getElementById('video').style.display = 'block';
    }

    // â”€â”€ UI Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const cameraSVG = '<svg width="34" height="34" viewBox="0 0 24 24" fill="none" stroke="var(--brown)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>';
    const cancelSVG = '<svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="var(--brown)" stroke-width="3" stroke-linecap="round"><line x1="6" y1="6" x2="18" y2="18"/><line x1="18" y1="6" x2="6" y2="18"/></svg>';

    function setScanningUI(on) {
      document.getElementById('scanOverlay').classList.toggle('visible', on);
      const scanBtn = document.getElementById('scanBtn');
      // Keep button enabled so user can cancel â€” swap icon
      scanBtn.disabled = false;
      scanBtn.innerHTML = on ? cancelSVG : cameraSVG;
      scanBtn.classList.toggle('scanning', on);
      document.getElementById('statusDot').className = on ? 'status-dot scanning' : 'status-dot ready';
    }

    function setFound(on) {
      document.getElementById('cameraFrame').classList.toggle('state-found', on);
    }

    const megaphoneSVG = '<svg class="megaphone-icon" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.5 3 L18.5 21 L7 15 L7 9 Z"/><path d="M7 9 L3.5 9 C2.7 9 2 9.7 2 10.5 L2 13.5 C2 14.3 2.7 15 3.5 15 L7 15"/><path d="M18.5 6 C20.5 8 20.5 16 18.5 18"/><path d="M7 15 L8 20 L11 20 L10 15"/></svg>';
    const replaySVG = '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>';
    const stopSVG = '<svg width="26" height="26" viewBox="0 0 24 24" fill="currentColor" stroke="none"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>';
    let hasAutoRead = false; // tracks if text has been read at least once

    function setSpeakState(state) {
      const btn = document.getElementById('speakBtn');
      btn.className = 'btn btn-speak';
      if (state === 'active')   btn.classList.add('active');
      if (state === 'speaking') btn.classList.add('speaking');
      // After first read, show replay icon instead of megaphone
      let icon = megaphoneSVG;
      if (state === 'speaking') icon = stopSVG;
      else if (state === 'active' && hasAutoRead) icon = replaySVG;
      btn.innerHTML = '<div class="waves"></div>' + icon;
    }

    function setRetryActive(on) {
      document.getElementById('retryBtn').classList.toggle('active', on);
    }

    function showBubble(text) {
      document.getElementById('resultText').textContent = text;
      document.getElementById('resultBubble').classList.add('visible');
    }

    function showBubbleHTML(html) {
      document.getElementById('resultText').innerHTML = html;
      document.getElementById('resultBubble').classList.add('visible');
    }

    function hideBubble() {
      document.getElementById('resultBubble').classList.remove('visible');
    }

    // â”€â”€ Word-by-word highlighting helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function showBubbleWithWords(text) {
      const container = document.getElementById('resultText');
      const wordPattern = /\S+/g;
      let match;
      let html = '';
      let lastEnd = 0;

      while ((match = wordPattern.exec(text)) !== null) {
        if (match.index > lastEnd) {
          html += escapeHtml(text.substring(lastEnd, match.index));
        }
        html += '<span class="word" data-start="' + match.index + '" data-end="' + (match.index + match[0].length) + '">' + escapeHtml(match[0]) + '</span>';
        lastEnd = match.index + match[0].length;
      }
      if (lastEnd < text.length) {
        html += escapeHtml(text.substring(lastEnd));
      }

      container.innerHTML = html;
      document.getElementById('resultBubble').classList.add('visible');
    }

    function highlightWordAt(charIndex) {
      clearHighlights();
      const spans = document.querySelectorAll('.ac-dialog-text .word');
      for (const span of spans) {
        const start = parseInt(span.dataset.start);
        const end   = parseInt(span.dataset.end);
        if (charIndex >= start && charIndex < end) {
          span.classList.add('highlight');
          span.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
          break;
        }
      }
    }

    function clearHighlights() {
      document.querySelectorAll('.ac-dialog-text .word.highlight').forEach(el => el.classList.remove('highlight'));
    }

    // â”€â”€ Context / Scene Explanation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setContextState(state) {
      const btn = document.getElementById('contextBtn');
      btn.className = 'btn btn-context';
      if (state === 'active')  btn.classList.add('active');
      if (state === 'loading') btn.classList.add('loading');
    }

    async function explainContext() {
      if (!recognizedText || !lastImageDataUrl) return;

      // If already loading, cancel
      if (contextController) {
        contextController.abort();
        contextController = null;
        setContextState('active');
        showBubbleWithWords(recognizedText);
        return;
      }

      // Cancel any ongoing speech
      cancelSpeech();
      clearHighlights();
      setSpeakState('active');
      document.getElementById('statusDot').className = 'status-dot ready';

      // Show loading state
      sfxContext();
      setContextState('loading');
      showBubbleHTML('<img src="leaf.webp" style="width:20px;height:20px;vertical-align:middle;animation:spin 0.9s linear infinite"> Thinking...');

      contextController = new AbortController();

      try {
        const response = await fetch('/api/context', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: lastImageDataUrl, text: recognizedText }),
          signal: contextController.signal,
        });

        if (!response.ok) throw new Error('Context API error');

        const data = await response.json();
        const context = (data.context || '').trim();

        setContextState('active');

        if (context) {
          // Update displayed text to context and show with word spans
          displayedText = context;
          showBubbleWithWords(context);
          setSpeakState('active');
          // Auto-read the context explanation
          setTimeout(() => speakText(true), 300);
        } else {
          showBubble('\uD83E\uDD14 Hmm, I\u2019m not sure what\u2019s happening here!');
        }
      } catch (e) {
        if (e.name === 'AbortError') {
          contextController = null;
          return;
        }
        setContextState('active');
        showBubble('\uD83D\uDE05 Couldn\u2019t explain \u2014 try again!');
      }

      contextController = null;
    }

    // â”€â”€ Guide / "What do I do?" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setGuideState(state) {
      const btn = document.getElementById('guideBtn');
      btn.className = 'btn btn-guide';
      if (state === 'active')  btn.classList.add('active');
      if (state === 'loading') btn.classList.add('loading');
    }

    async function explainGuide() {
      if (!recognizedText || !lastImageDataUrl) return;

      // If already loading, cancel
      if (guideController) {
        guideController.abort();
        guideController = null;
        setGuideState('active');
        showBubbleWithWords(recognizedText);
        return;
      }

      // Cancel any ongoing speech
      cancelSpeech();
      clearHighlights();
      setSpeakState('active');
      document.getElementById('statusDot').className = 'status-dot ready';

      // Show loading state
      sfxGuide();
      setGuideState('loading');
      showBubbleHTML('<img src="leaf.webp" style="width:20px;height:20px;vertical-align:middle;animation:spin 0.9s linear infinite"> Thinking...');

      guideController = new AbortController();

      try {
        const response = await fetch('/api/guide', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: lastImageDataUrl, text: recognizedText }),
          signal: guideController.signal,
        });

        if (!response.ok) throw new Error('Guide API error');

        const data = await response.json();
        const guide = (data.guide || '').trim();

        setGuideState('active');

        if (guide) {
          displayedText = guide;
          showBubbleWithWords(guide);
          setSpeakState('active');
          // Auto-read the guide response
          setTimeout(() => speakText(true), 300);
        } else {
          showBubble('\u{1F914} Hmm, I\u2019m not sure what to do here!');
        }
      } catch (e) {
        if (e.name === 'AbortError') {
          guideController = null;
          return;
        }
        setGuideState('active');
        showBubble('\u{1F605} Couldn\u2019t figure it out \u2014 try again!');
      }

      guideController = null;
    }

    // â”€â”€ Confetti burst â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function spawnConfetti() {
      const frame  = document.getElementById('cameraFrame');
      const colors = ['#f5d45a', '#7ec97f', '#a8d9ec', '#f5a8b8', '#f0921e', '#fffef5'];
      const cx = frame.offsetWidth / 2;
      const cy = frame.offsetHeight / 2;

      for (let i = 0; i < 18; i++) {
        const dot   = document.createElement('div');
        dot.className = 'confetti-dot';
        const angle = (i / 18) * 360;
        const dist  = 60 + Math.random() * 80;
        const dx    = Math.cos(angle * Math.PI / 180) * dist;
        const dy    = Math.sin(angle * Math.PI / 180) * dist;
        const size  = 8 + Math.random() * 8;

        dot.style.cssText =
          'width:' + size + 'px;' +
          'height:' + size + 'px;' +
          'background:' + colors[i % colors.length] + ';' +
          'left:' + cx + 'px;' +
          'top:' + cy + 'px;' +
          '--end-pos:translate(' + dx + 'px,' + dy + 'px);' +
          'animation-delay:' + (Math.random() * 0.1) + 's;';

        frame.appendChild(dot);
        setTimeout(() => dot.remove(), 900);
      }
    }

    // â”€â”€ iOS: pre-load voices â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (window.speechSynthesis) {
      window.speechSynthesis.onvoiceschanged = () => {
        window.speechSynthesis.getVoices();
      };
      // Trigger initial load
      window.speechSynthesis.getVoices();
    }
  </script>
</body>
</html>
